
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOLA VENTAS - Online</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Tailwind configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#10B981', // Emerald 500
                        secondary: '#F59E0B', // Amber 500
                        accent: '#EF4444', // Red 500
                        darkbg: '#1F2937', // Gray 800
                        lightbg: '#F3F4F6', // Gray 100
                        textlight: '#F9FAFB', // Gray 50
                        textdark: '#111827', // Gray 900
                        level1: '#6366F1', // Indigo 500 for Level 1 user
                    }
                }
            }
        }
    </script>
    <style>
        /* Embed Pitched Battle font via Base64 */
        @font-face {
            font-family: 'Pitched Battle';
            src: url('data:font/truetype;base64,AAEAAAANAIAAAwBQRkZUTXhH4P0AAATwAAAAHEdERUYAKAAPAAAE1AAAACBPUy8y9N1VBAAAAVgAAABgY21hcBiwR/8AAAGkAAABQmdhc3D//wADAAAEuAAAAAhnbHlmFh9V+AAABAgAAAJUaGVhZNkP1XMAAAEEAAAANmhoZWEIIAUDAAABPAAAACRobXR4DMYABgAAAUwAAAAIbG9jYYWbAiwAAAS4AAAAAmhheHABgAFIAAAEwAAAACBuYW1l49/y+AAABOgAAAIgcG9zdN2X70MAAAWQAAAAJHBwcmVp2P+/AAAFAAAAB2dhc3AAAAMDAAEAAAADAAAAAMIAAQAAAYEBAAEBqgAHAAAOAAABAAQAAAABAAEAAQAAAgAaACcAZwBkAAAAAAEgAAAAAAAAAAEAAADQ7c13/wAAANgP1XMAAAAAANgL3f0AAAMDAAEAAAAAAAAAAAABAAAALgAAAAAAAgAAAAAAAAAAAMABQAHAAQAAQD6/v7+AAEAAgAAAAAAAgAAAAD8AAAAAQAAAMjKxP////8AQQAAAAYAAAASACAAAQAAAAFAAcAAQAAACQAHgACAAEAAAAkAPoAAgAEAAAEf//AAAAQAAAAAMDAAEAAAAAAAAAAQMAAQMAAAAEAAABMgAAAAAAAAAAAVQALAAoAAAHIAAEAAAAoAAgAAQAAAAoAAwAAQAAADQALgABAAAALgA2ACcABgAAAAC4APoAAQAAAAAAPgBIAAgAAQAAAAAAUgBQAAgAAQAAAAAAXgBUAAgAAQAAAAAAcABWAAgAAQAAAAAAdgBYAAgAAQAAAAAAdgBaAAgAAQAAAAAAfgBfAAgAAQAAAAAAgQBgAAgAAQAAAAAAggBiAAgAAQAAAAAAhABoAAgAAQAAAAAAiABsAAgAAQAAAAAAjgBqAAgAAQAAAAAAkwBwAAgAAQAAAAAAqgB3AAgAAQAAAAArwB5AAgAAQAAAAAAwgB7AAgAAQAAAAAAygB9AAgAAQAAAAAA0gB/AAgAAQAAAAAA2gCBAAgAAQAAAAAA4gCEAAgAAQAAAAAA5QCBQAoAAADcAMkACAAFAAAAAAAADcALAAKAAACQAAEAAAACgADAAgAAAAMAAIAIAACAAoADQAAAAAgADkACAAAAIAAIADoAAAABwAEAAEAAAAAACwADgACAAIAAAADAAAAAAAAAAAAAAAAAAEDAAECAwQFBgcICQoLDA0ODxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4Ojs8PT4/QEFCQwECAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        h1, h2 { font-family: 'Pitched Battle', sans-serif; }
        .disabled-input {
            opacity: 0.7;
            cursor: not-allowed;
            background-color: #E5E7EB; /* gray-200 */
            color: #4B5563; /* gray-600 */
        }
        .dark .disabled-input {
            background-color: #374151; /* gray-700 */
            color: #D1D5DB; /* gray-300 */
        }
    </style>
    <!-- Load React, ReactDOM, Babel, jsPDF, Tone.js -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>

    <!-- FIREBASE CDNs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-lightbg dark:bg-darkbg text-textdark dark:text-textlight min-h-screen flex items-center justify-center font-sans">
    <div id="root"></div>
    <script type="text/babel">
      // --- Constants ---
      const ADMIN_USER = 'regis';
      const SALES_USER = 'lol';
      const LEVEL1_USER = 'nivel1'; // New constant for Level 1 user

      // --- FIREBASE CONFIGURATION ---
      const firebaseConfig = {
        apiKey: "AIzaSyCV8xMEGp5LHt0DSQ6ZwExfoAOEsReoxK4",
        authDomain: "lolaventas-5a9fa.firebaseapp.com",
        projectId: "lolaventas-5a9fa",
        storageBucket: "lolaventas-5a9fa.firebasestorage.app",
        messagingSenderId: "768407272770",
        appId: "1:768407272770:web:efce39214308dafdea9cdb"
      };

      // --- Initialize Firebase ---
      let db = null;
      let firebaseInitialized = false;
      let isDemoMode = false; // Flag for demo/offline mode

      // `measurementId` from the user's provided snippet is not needed for compat SDK v9.23.0 `firebase-app-compat.js`
      // and for the current functionality. It is typically for Google Analytics, which is not actively used here.
      // So, `isFirebaseConfigured` check is now simpler.
      const isFirebaseConfigured = !firebaseConfig.apiKey.includes("TU_API_KEY");

      if (isFirebaseConfigured) {
        try {
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            firebaseInitialized = true;
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
      }

      // --- Local Storage Mock for Demo Mode ---
      const mockStorage = {
          config: null,
          sales: [],
          history: []
      };

      // --- DB Service ---
      const dbService = {
        subscribeToActiveConfig: (callback) => {
            if (isDemoMode) {
                callback(mockStorage.config);
                return () => {};
            }
            if (!db) return () => {};
            return db.collection('feria_config').doc('active')
                .onSnapshot((doc) => {
                    callback(doc.exists ? doc.data() : null);
                }, (error) => console.error("Error listening to config:", error));
        },

        saveActiveFeriaConfig: async (config) => {
            if (isDemoMode) {
                mockStorage.config = config;
                alert("Guardado en Modo Demo (se perderá al recargar)");
                // Force update manually in demo since no snapshot
                window.dispatchEvent(new CustomEvent('demo-update'));
                return;
            }
            if (!db) return;
            try {
                await db.collection('feria_config').doc('active').set(config);
            } catch (e) {
                alert("Error guardando: " + e.message);
            }
        },

        subscribeToActiveSales: (callback) => {
            if (isDemoMode) {
                callback(mockStorage.sales);
                // Listen to demo event to refresh
                const handler = () => callback([...mockStorage.sales]);
                window.addEventListener('demo-update', handler);
                return () => window.removeEventListener('demo-update', handler);
            }
            if (!db) return () => {};
            return db.collection('active_sales').orderBy('fechaVenta', 'desc')
                .onSnapshot((snapshot) => {
                    const sales = [];
                    snapshot.forEach((doc) => sales.push({ ...doc.data(), id: doc.id }));
                    callback(sales);
                }, (error) => console.error("Error listening to sales:", error));
        },

        addSale: async (sale) => {
            if (isDemoMode) {
                mockStorage.sales.unshift(sale);
                window.dispatchEvent(new CustomEvent('demo-update'));
                return;
            }
            if (!db) return;
            try {
                await db.collection('active_sales').doc(sale.id).set(sale);
            } catch (e) {
                alert("Error venta: " + e.message);
            }
        },

        subscribeToHistory: (callback) => {
            if (isDemoMode) {
                callback(mockStorage.history);
                const handler = () => callback([...mockStorage.history]);
                window.addEventListener('demo-update', handler);
                return () => window.removeEventListener('demo-update', handler);
            }
            if (!db) return () => {};
            return db.collection('feria_history').orderBy('archivedAt', 'desc')
                .onSnapshot((snapshot) => {
                    const history = [];
                    snapshot.forEach((doc) => history.push({ ...doc.data(), id: doc.id }));
                    callback(history);
                }, (error) => console.error("Error listening to history:", error));
        },

        archiveFeria: async (config, sales, reportSummary) => {
             if (isDemoMode) {
                const historyData = {
                    id: crypto.randomUUID(),
                    config: config,
                    sales: sales,
                    reportSummary: reportSummary,
                    archivedAt: new Date().toISOString(),
                };
                mockStorage.history.unshift(historyData);
                mockStorage.config = null;
                mockStorage.sales = [];
                window.dispatchEvent(new CustomEvent('demo-update'));
                return;
            }
            if (!db) return;
            try {
                const batch = db.batch();
                const newHistoryRef = db.collection('feria_history').doc();
                batch.set(newHistoryRef, {
                    id: newHistoryRef.id,
                    config, sales, reportSummary, archivedAt: new Date().toISOString()
                });
                batch.delete(db.collection('feria_config').doc('active'));
                await batch.commit();

                // Delete active sales
                const salesSnapshot = await db.collection('active_sales').get();
                const deleteBatch = db.batch();
                salesSnapshot.forEach(doc => deleteBatch.delete(doc.ref));
                await deleteBatch.commit();
            } catch (e) {
                alert("Error archivando: " + e.message);
            }
        },

        activateHistoricalFeria: async (feriaHistoryItem) => {
             if (isDemoMode) {
                mockStorage.config = feriaHistoryItem.config;
                mockStorage.sales = feriaHistoryItem.sales;
                mockStorage.history = mockStorage.history.filter(h => h.id !== feriaHistoryItem.id);
                window.dispatchEvent(new CustomEvent('demo-update'));
                return;
            }
            // Implementation for firebase existing...
             if (!db) return;
            try {
                const batch = db.batch();
                batch.set(db.collection('feria_config').doc('active'), feriaHistoryItem.config);
                batch.delete(db.collection('feria_history').doc(feriaHistoryItem.id));
                await batch.commit();
                
                // Restore sales (simplified batch)
                const sales = feriaHistoryItem.sales;
                const salesBatch = db.batch();
                sales.forEach(sale => {
                    salesBatch.set(db.collection('active_sales').doc(sale.id), sale);
                });
                await salesBatch.commit();
            } catch(e) { console.error(e); }
        },

        deleteHistoricalFeria: async (id) => {
             if (isDemoMode) {
                mockStorage.history = mockStorage.history.filter(h => h.id !== id);
                window.dispatchEvent(new CustomEvent('demo-update'));
                return;
            }
            if(!db) return;
            try { await db.collection('feria_history').doc(id).delete(); } catch(e) { console.error(e); }
        }
      };

      // --- Helper Functions & Components ---
      const TipoUnidad = { Pinta: 'Pinta', Litro: 'Litro', Mixed: 'Mixed' };
      const TipoPago = { Digital: '$ Digital', Billete: '$ Billete' };

      const calculateReportSummary = (feriaConfig, sales) => {
        let totalPintas = 0;
        let totalLitros = 0;
        let montoTotalGeneral = 0;
        let montoTotalDigital = 0;
        let montoTotalBillete = 0;

        sales.forEach((sale) => {
          montoTotalGeneral += sale.montoTotal;
          if (sale.tipoPago === TipoPago.Digital) montoTotalDigital += sale.montoTotal;
          else montoTotalBillete += sale.montoTotal;

          // Ensure sale.cantidadUnidades is treated as a number
          const cantidad = parseFloat(sale.cantidadUnidades);

          if (sale.tipoUnidad === TipoUnidad.Pinta) totalPintas += cantidad;
          else if (sale.tipoUnidad === TipoUnidad.Litro) totalLitros += cantidad;
          else if (sale.tipoUnidad === TipoUnidad.Mixed) {
              totalPintas += cantidad / 2;
              totalLitros += cantidad / 2;
          }
        });
        return {
          totalPintas: Math.round(totalPintas),
          totalLitros: Math.round(totalLitros),
          montoTotalGeneral: parseFloat(montoTotalGeneral.toFixed(2)),
          montoTotalDigital: parseFloat(montoTotalDigital.toFixed(2)),
          montoTotalBillete: parseFloat(montoTotalBillete.toFixed(2)),
        };
      };

      const ConfigWarning = ({ onEnableDemo }) => (
        <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
            <div className="bg-white p-8 rounded-lg shadow-xl max-w-2xl text-center">
                <h1 className="text-3xl font-bold text-red-600 mb-4">¡Falta Configuración!</h1>
                <p className="text-lg text-gray-700 mb-6">
                    Para usar esta app en modo online, necesitas configurar las claves de Firebase en el archivo <code>index.html</code>.
                </p>
                <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 text-left">
                    <p className="text-sm text-yellow-700">
                        <strong>¿Quieres probarla ahora?</strong><br/>
                        Puedes activar el modo Demo. Los datos se guardarán temporalmente en tu navegador pero no se compartirán con otros usuarios.
                    </p>
                </div>
                <button 
                    onClick={onEnableDemo}
                    className="w-full py-3 px-6 bg-blue-600 text-white rounded-md font-bold hover:bg-blue-700 transition-colors"
                >
                    PROBAR MODO DEMO (OFFLINE)
                </button>
                <p className="mt-4 text-xs text-gray-400">Edita el código fuente para añadir las claves de Firebase.</p>
            </div>
        </div>
      );

      // --- Main Components ---
      const AuthScreen = ({ onLogin, hasActiveFeria, playSound, generalClickSoundRef }) => {
        const [username, setUsername] = React.useState('');
        const [error, setError] = React.useState(null);

        const handleLogin = (role) => {
            playSound(generalClickSoundRef, 'C5', '32n');
            if (role === 'admin' && username === ADMIN_USER) {
                onLogin('admin');
            } else if (role === 'sales' && username === SALES_USER) {
                onLogin('sales');
            } else if (role === 'level1' && username === LEVEL1_USER) { // New login for Level 1
                onLogin('level1');
            } else {
                setError('Usuario o rol incorrecto.');
            }
        };

        return (
          <div className="flex flex-col items-center p-8 bg-gray-50 dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-600 max-w-2xl w-full">
            <h2 className="text-4xl font-bold text-primary mb-6 text-center">LOLA VENTAS</h2>
            <input
              type="text"
              className="w-full p-3 mb-4 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-textlight text-textdark"
              placeholder="Usuario (regis / lol / nivel1)"
              value={username}
              onChange={(e) => { setUsername(e.target.value); setError(null); }}
            />
            {error && <p className="text-accent text-sm mb-4">{error}</p>}
            <div className="flex flex-col space-y-4 w-full">
              <button onClick={() => handleLogin('admin')} className="w-full py-3 px-6 bg-primary text-white rounded-md font-semibold">Iniciar como ADMINISTRADOR</button>
              <button onClick={() => handleLogin('sales')} disabled={!hasActiveFeria} className={`w-full py-3 px-6 rounded-md font-semibold text-white ${hasActiveFeria ? 'bg-secondary' : 'bg-gray-400'}`}>Iniciar como VENTA</button>
              <button onClick={() => handleLogin('level1')} disabled={!hasActiveFeria} className={`w-full py-3 px-6 rounded-md font-semibold text-white ${hasActiveFeria ? 'bg-level1' : 'bg-gray-400'}`}>Iniciar como NIVEL 1</button> {/* New button */}
            </div>
          </div>
        );
      };

      const SalesTPV = ({ activeFeriaConfig, onAddSale, onLogout, playSound, digitalPaymentSynthRef, billetePaymentSynthRef, pintaAddSynthRef, pintaSubSynthRef, litroAddSynthRef, litroSubSynthRef, generalClickSoundRef }) => {
        const [pintaCount, setPintaCount] = React.useState(0);
        const [litroCount, setLitroCount] = React.useState(0);
        const [showLoadedMessage, setShowLoadedMessage] = React.useState(false);

        const handleRegisterSale = (tipoPago) => {
          if (pintaCount === 0 && litroCount === 0) return;
          const montoTotal = parseFloat((pintaCount * activeFeriaConfig.valorPinta + litroCount * activeFeriaConfig.valorLitro).toFixed(2));
          const newSale = {
            id: crypto.randomUUID(),
            fechaVenta: new Date().toISOString(),
            tipoUnidad: (pintaCount > 0 && litroCount > 0) ? TipoUnidad.Mixed : (pintaCount > 0 ? TipoUnidad.Pinta : TipoUnidad.Litro),
            cantidadUnidades: pintaCount + litroCount,
            montoTotal,
            tipoPago,
            usuarioVenta: SALES_USER,
          };
          onAddSale(newSale);
          setPintaCount(0); setLitroCount(0); setShowLoadedMessage(true);
          playSound(tipoPago === TipoPago.Digital ? digitalPaymentSynthRef : billetePaymentSynthRef, tipoPago === TipoPago.Digital ? 'C6' : 'G3', '8n');
          setTimeout(() => setShowLoadedMessage(false), 1500);
        };

        const hasItemsSelected = pintaCount > 0 || litroCount > 0;
        const total = (pintaCount * activeFeriaConfig.valorPinta + litroCount * activeFeriaConfig.valorLitro).toFixed(2);

        return (
          <div className="flex flex-col p-4 bg-gray-50 dark:bg-gray-800 rounded-lg shadow-xl h-full relative">
            <div className="flex justify-between items-center mb-4 border-b pb-2 dark:border-gray-600">
              <h1 className="text-3xl font-bold text-secondary">VENTA</h1>
              <button onClick={() => { playSound(generalClickSoundRef); onLogout(); }} className="py-1 px-3 bg-accent text-white rounded">Salir</button>
            </div>
            <p className="text-xl text-center mb-4 text-gray-700 dark:text-gray-300">Feria: <span className="font-bold text-primary">{activeFeriaConfig.nombreFeria}</span></p>
            
            <div className="grid grid-cols-2 gap-4 mb-4">
                 <div className="relative flex flex-col items-center justify-center p-4 bg-blue-500 text-white rounded-lg h-32 cursor-pointer" onClick={() => { setPintaCount(p => p+1); playSound(pintaAddSynthRef, 'C5', '16n'); }}>
                    <span className="text-2xl font-bold">PINTA</span>
                    <span className="text-xs">${activeFeriaConfig.valorPinta}</span>
                    <span className="text-4xl font-bold mt-1">{pintaCount}</span>
                    {pintaCount > 0 && <button onClick={(e) => { e.stopPropagation(); setPintaCount(p => Math.max(0, p-1)); playSound(pintaSubSynthRef, 'C4', '16n'); }} className="absolute left-0 top-0 bottom-0 w-1/4 bg-blue-700 rounded-l-lg text-xl">-</button>}
                 </div>
                 <div className="relative flex flex-col items-center justify-center p-4 bg-purple-500 text-white rounded-lg h-32 cursor-pointer" onClick={() => { setLitroCount(p => p+1); playSound(litroAddSynthRef, 'E5', '16n'); }}>
                    <span className="text-2xl font-bold">LITRO</span>
                    <span className="text-xs">${activeFeriaConfig.valorLitro}</span>
                    <span className="text-4xl font-bold mt-1">{litroCount}</span>
                    {litroCount > 0 && <button onClick={(e) => { e.stopPropagation(); setLitroCount(p => Math.max(0, p-1)); playSound(litroSubSynthRef, 'E4', '16n'); }} className="absolute left-0 top-0 bottom-0 w-1/4 bg-purple-700 rounded-l-lg text-xl">-</button>}
                 </div>
            </div>
            
            <div className="bg-gray-200 dark:bg-gray-900 p-3 rounded mb-4 text-center">
                 <span className="text-2xl font-bold text-textdark dark:text-textlight">TOTAL: <span className="text-primary">${total}</span></span>
            </div>

            <div className="flex flex-col gap-3">
                 <button onClick={() => handleRegisterSale(TipoPago.Digital)} disabled={!hasItemsSelected} className={`py-4 rounded font-bold text-white text-xl ${hasItemsSelected ? 'bg-primary' : 'bg-gray-400'}`}>$ DIGITAL</button>
                 <button onClick={() => handleRegisterSale(TipoPago.Billete)} disabled={!hasItemsSelected} className={`py-4 rounded font-bold text-white text-xl ${hasItemsSelected ? 'bg-secondary' : 'bg-gray-400'}`}>$ BILLETE</button>
            </div>
            {showLoadedMessage && <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-80 text-white text-4xl font-bold rounded z-50 animate-pulse">CARGADO!</div>}
          </div>
        );
      };

      const FeriaConfigForm = ({ activeFeriaConfig, onSave, onFinalizeFeria, userRole }) => {
          const [form, setForm] = React.useState({ nombreFeria: '', fechaInicio: '', fechaFin: '', valorPinta: 0, valorLitro: 0 });
          React.useEffect(() => { if(activeFeriaConfig) setForm(activeFeriaConfig); }, [activeFeriaConfig]);

          const isLevel1 = userRole === LEVEL1_USER;
          const isFullAdmin = userRole === ADMIN_USER;

          return (
              <div className="space-y-4">
                  <h3 className="text-2xl font-semibold text-textdark dark:text-textlight">Configuración</h3>
                  {activeFeriaConfig && <div className="bg-green-100 p-2 rounded text-green-800 dark:bg-green-900 dark:text-green-200">Feria Activa: {activeFeriaConfig.nombreFeria}</div>}
                  <input 
                      type="text" 
                      placeholder="Nombre de la Feria" 
                      className={`w-full p-2 border rounded ${isLevel1 ? 'disabled-input' : ''}`} 
                      value={form.nombreFeria} 
                      onChange={e => setForm({...form, nombreFeria: e.target.value})} 
                      disabled={isLevel1}
                  />
                  <div className="grid grid-cols-2 gap-4">
                      <input 
                          type="date" 
                          className={`p-2 border rounded ${isLevel1 ? 'disabled-input' : ''}`} 
                          value={form.fechaInicio} 
                          onChange={e => setForm({...form, fechaInicio: e.target.value})} 
                          disabled={isLevel1}
                      />
                      <input 
                          type="date" 
                          className={`p-2 border rounded ${isLevel1 ? 'disabled-input' : ''}`} 
                          value={form.fechaFin} 
                          onChange={e => setForm({...form, fechaFin: e.target.value})} 
                          disabled={isLevel1}
                      />
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                      <input 
                          type="number" 
                          placeholder="Valor Pinta" 
                          className="p-2 border rounded" 
                          value={form.valorPinta} 
                          onChange={e => setForm({...form, valorPinta: parseFloat(e.target.value) || 0})} // Ensure number
                      />
                      <input 
                          type="number" 
                          placeholder="Valor Litro" 
                          className="p-2 border rounded" 
                          value={form.valorLitro} 
                          onChange={e => setForm({...form, valorLitro: parseFloat(e.target.value) || 0})} // Ensure number
                      />
                  </div>
                  <button onClick={() => onSave(form)} className="w-full py-3 bg-primary text-white rounded font-bold">Guardar</button>
                  {isFullAdmin && activeFeriaConfig && ( // Only show finalize button for full admin
                    <button onClick={() => { if(confirm("¿Estás seguro de finalizar la feria? Esta acción no se puede deshacer fácilmente.")) onFinalizeFeria(); }} className="w-full py-3 bg-accent text-white rounded font-bold">Finalizar Feria</button>
                  )}
              </div>
          );
      };

      const SalesReport = ({ activeFeriaConfig, activeSales, onFinalizeFeria }) => {
          if (!activeFeriaConfig) return <div className="text-center p-4">No hay feria activa.</div>;
          const report = calculateReportSummary(activeFeriaConfig, activeSales);
          
          const handleShare = () => {
             const msg = `Feria: ${activeFeriaConfig.nombreFeria}\nTotal: $${report.montoTotalGeneral}\n\nDetalle:\nPintas: ${report.totalPintas}\nLitros: ${report.totalLitros}\nDigital: $${report.montoTotalDigital}\nBillete: $${report.montoTotalBillete}`;
             window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
          };

          return (
              <div className="space-y-4">
                  <h3 className="text-2xl font-bold text-textdark dark:text-textlight">Reporte Actual</h3>
                  <div className="bg-white dark:bg-gray-700 p-4 rounded shadow">
                      <p className="text-lg">Pintas: <b>{report.totalPintas}</b></p>
                      <p className="text-lg">Litros: <b>{report.totalLitros}</b></p>
                      <hr className="my-2 border-gray-200 dark:border-gray-600"/>
                      <p className="text-2xl">Total General: <b className="text-primary">${report.montoTotalGeneral}</b></p>
                      <p className="text-base text-gray-600 dark:text-gray-300">Digital: ${report.montoTotalDigital} | Billete: ${report.montoTotalBillete}</p>
                  </div>
                  <button onClick={handleShare} className="w-full py-3 bg-green-500 text-white rounded font-bold">Compartir WhatsApp</button>
              </div>
          );
      };

      const FeriaHistoryList = ({ history, onDelete, onActivate, onReport }) => (
          <div className="space-y-4">
              <h3 className="text-2xl font-bold text-textdark dark:text-textlight">Historial</h3>
              {history.length === 0 && <p className="dark:text-gray-300">No hay historial de ferias.</p>}
              {history.map(h => (
                  <div key={h.id} className="bg-white dark:bg-gray-700 p-4 rounded shadow flex justify-between items-center">
                      <div>
                          <p className="font-bold dark:text-textlight">{h.config.nombreFeria}</p>
                          <p className="text-sm dark:text-gray-300">Total: ${h.reportSummary.montoTotalGeneral}</p>
                          <p className="text-xs text-gray-500 dark:text-gray-400">Archivado: {new Date(h.archivedAt).toLocaleDateString()}</p>
                      </div>
                      <div className="gap-2 flex">
                        <button onClick={() => onReport(h)} className="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">Ver</button>
                        <button onClick={() => onActivate(h)} className="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">Activar</button>
                        <button onClick={() => { if(confirm("¿Borrar feria del historial? Esta acción es irreversible.")) onDelete(h.id); }} className="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">X</button>
                      </div>
                  </div>
              ))}
          </div>
      );

      const Level1Dashboard = ({ activeFeriaConfig, onSaveConfig, onLogout }) => {
        return (
            <div className="p-4 max-w-xl w-full bg-white dark:bg-gray-800 rounded shadow-lg min-h-[80vh]">
                <div className="flex justify-between items-center mb-4 border-b pb-2 dark:border-gray-600">
                    <h1 className="text-2xl font-bold text-level1">Nivel 1 {isDemoMode && '(DEMO)'}</h1>
                    <button onClick={onLogout} className="text-red-500 font-bold">Salir</button>
                </div>
                <FeriaConfigForm 
                    activeFeriaConfig={activeFeriaConfig} 
                    onSave={onSaveConfig} 
                    userRole={LEVEL1_USER} // Pass role to restrict form
                />
            </div>
        );
      };


      const App = () => {
        const [userRole, setUserRole] = React.useState(null);
        const [activeFeriaConfig, setActiveFeriaConfig] = React.useState(null);
        const [activeSales, setActiveSales] = React.useState([]);
        const [feriaHistory, setFeriaHistory] = React.useState([]);
        const [view, setView] = React.useState('config'); // Default view for admin
        const [demoEnabled, setDemoEnabled] = React.useState(false);

        // Sound Refs
        const digitalPaymentSynthRef = React.useRef(null);
        const billetePaymentSynthRef = React.useRef(null);
        const pintaAddSynthRef = React.useRef(null);
        const pintaSubSynthRef = React.useRef(null);
        const litroAddSynthRef = React.useRef(null);
        const litroSubSynthRef = React.useRef(null);
        const generalClickSoundRef = React.useRef(null);

        React.useEffect(() => {
            const initSynths = async () => {
                if (typeof Tone !== 'undefined' && Tone.context.state !== 'running') {
                    await Tone.start();
                    digitalPaymentSynthRef.current = new Tone.Synth().toDestination();
                    billetePaymentSynthRef.current = new Tone.Synth().toDestination();
                    pintaAddSynthRef.current = new Tone.Synth().toDestination();
                    pintaSubSynthRef.current = new Tone.Synth().toDestination();
                    litroAddSynthRef.current = new Tone.Synth().toDestination();
                    litroSubSynthRef.current = new Tone.Synth().toDestination();
                    generalClickSoundRef.current = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.05 }}).toDestination();
                }
            };
            // Use passive event listener for better performance
            document.body.addEventListener('click', initSynths, { once: true, passive: true });
            return () => {
                document.body.removeEventListener('click', initSynths);
            };
        }, []);

        const playSound = (synth, note, dur) => { 
            if(synth?.current && Tone.context.state === 'running') {
                synth.current.triggerAttackRelease(note || 'C5', dur || '8n'); 
            }
        };

        React.useEffect(() => {
            if (!isFirebaseConfigured && !demoEnabled) return;
            
            // Set global demo flag
            isDemoMode = demoEnabled;

            const unsubConfig = dbService.subscribeToActiveConfig(setActiveFeriaConfig);
            const unsubSales = dbService.subscribeToActiveSales(setActiveSales);
            const unsubHistory = dbService.subscribeToHistory(setFeriaHistory);
            return () => { unsubConfig(); unsubSales(); unsubHistory(); };
        }, [demoEnabled]);

        if (!isFirebaseConfigured && !demoEnabled) {
            return <ConfigWarning onEnableDemo={() => setDemoEnabled(true)} />;
        }

        if (!userRole) return <AuthScreen onLogin={setUserRole} hasActiveFeria={!!activeFeriaConfig} playSound={playSound} generalClickSoundRef={generalClickSoundRef} />;
        
        if (userRole === SALES_USER) {
            if (!activeFeriaConfig) return <div className="text-center p-8 bg-gray-50 dark:bg-gray-800 rounded-lg shadow-xl max-w-xl w-full mx-auto">
                <h2 className="text-2xl font-bold text-accent mb-4">No hay feria activa</h2>
                <p className="text-gray-700 dark:text-gray-300">Por favor, espera a que un administrador configure una feria.</p>
                <button onClick={() => setUserRole(null)} className="mt-4 py-2 px-4 bg-accent text-white rounded">Volver</button>
            </div>;
            return <SalesTPV activeFeriaConfig={activeFeriaConfig} onAddSale={dbService.addSale} onLogout={() => setUserRole(null)} playSound={playSound} digitalPaymentSynthRef={digitalPaymentSynthRef} billetePaymentSynthRef={billetePaymentSynthRef} pintaAddSynthRef={pintaAddSynthRef} pintaSubSynthRef={pintaSubSynthRef} litroAddSynthRef={litroAddSynthRef} litroSubSynthRef={litroSubSynthRef} generalClickSoundRef={generalClickSoundRef} />;
        }

        if (userRole === LEVEL1_USER) {
             if (!activeFeriaConfig) return <div className="text-center p-8 bg-gray-50 dark:bg-gray-800 rounded-lg shadow-xl max-w-xl w-full mx-auto">
                <h2 className="text-2xl font-bold text-accent mb-4">No hay feria activa</h2>
                <p className="text-gray-700 dark:text-gray-300">Por favor, espera a que un administrador configure una feria.</p>
                <button onClick={() => setUserRole(null)} className="mt-4 py-2 px-4 bg-accent text-white rounded">Volver</button>
            </div>;
            return <Level1Dashboard 
                activeFeriaConfig={activeFeriaConfig} 
                onSaveConfig={dbService.saveActiveFeriaConfig} 
                onLogout={() => setUserRole(null)}
            />;
        }

        // Admin Dashboard
        return (
            <div className="p-4 max-w-4xl w-full bg-white dark:bg-gray-800 rounded shadow-lg min-h-[80vh]">
                <div className="flex justify-between items-center mb-4 border-b pb-2 dark:border-gray-600">
                    <h1 className="text-2xl font-bold text-primary">Admin {isDemoMode && '(DEMO)'}</h1>
                    <button onClick={() => setUserRole(null)} className="text-red-500 font-bold">Salir</button>
                </div>
                <div className="flex gap-2 mb-4">
                    <button onClick={() => setView('config')} className={`px-4 py-2 rounded ${view === 'config' ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-700 dark:text-gray-200'}`}>Config</button>
                    <button onClick={() => setView('report')} className={`px-4 py-2 rounded ${view === 'report' ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-700 dark:text-gray-200'}`}>Reporte</button>
                    <button onClick={() => setView('history')} className={`px-4 py-2 rounded ${view === 'history' ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-700 dark:text-gray-200'}`}>Historial</button>
                </div>
                {view === 'config' && <FeriaConfigForm activeFeriaConfig={activeFeriaConfig} onSave={dbService.saveActiveFeriaConfig} onFinalizeFeria={() => dbService.archiveFeria(activeFeriaConfig, activeSales, calculateReportSummary(activeFeriaConfig, activeSales))} userRole={ADMIN_USER} />}
                {view === 'report' && <SalesReport activeFeriaConfig={activeFeriaConfig} activeSales={activeSales} onFinalizeFeria={() => dbService.archiveFeria(activeFeriaConfig, activeSales, calculateReportSummary(activeFeriaConfig, activeSales))} />}
                {view === 'history' && <FeriaHistoryList history={feriaHistory} onDelete={dbService.deleteHistoricalFeria} onActivate={dbService.activateHistoricalFeria} onReport={(h) => { const doc = new window.jspdf.jsPDF(); doc.setFontSize(10); doc.text(`Reporte de Feria: ${h.config.nombreFeria}`, 10, 10); doc.text(`Fechas: ${h.config.fechaInicio} - ${h.config.fechaFin}`, 10, 16); doc.text(`Valores: Pinta $${h.config.valorPinta}, Litro $${h.config.valorLitro}`, 10, 22); doc.text(`Total General: $${h.reportSummary.montoTotalGeneral}`, 10, 30); doc.text(`Total Digital: $${h.reportSummary.montoTotalDigital}`, 10, 36); doc.text(`Total Billete: $${h.reportSummary.montoTotalBillete}`, 10, 42); doc.text(`Unidades: ${h.reportSummary.totalPintas} Pintas, ${h.reportSummary.totalLitros} Litros`, 10, 48); doc.save(`${h.config.nombreFeria}-reporte.pdf`); }} />}
            </div>
        );
      };

      // --- MOUNTING LOGIC ---
      const renderApp = () => {
          const rootElement = document.getElementById('root');
          if (!rootElement) return;
          try {
              const root = window.ReactDOM.createRoot(rootElement);
              root.render(<React.StrictMode><App /></React.StrictMode>);
          } catch (err) {
              rootElement.innerHTML = `<div style="color:red; padding: 20px;">Error rendering app: ${err.message}</div>`;
              console.error(err);
          }
      };

      if (document.readyState === 'complete' || document.readyState === 'interactive') {
          renderApp();
      } else {
          window.addEventListener('DOMContentLoaded', renderApp);
      }
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
